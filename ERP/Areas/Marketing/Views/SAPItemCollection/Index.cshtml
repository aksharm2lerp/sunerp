@using Microsoft.AspNetCore.Identity
@using Business.SQL
@using GridCore
@using System.Data;
@addTagHelper *, GridMvc
@model ISGrid
@{
    Layout = "~/Views/Shared/_LayoutMaster.cshtml";
    ViewBag.Title = "SAP Item Collection..";
    var test = Model;
    List<string> strTimeforRow = new List<string>();
    string itemGroup = ViewBag.ItemGroup;
    string wareHouse = ViewBag.WareHouse;
}
<style>
    .grid-wrap {
        overflow-y: scroll !important;
        overflow-x: scroll !important;
    }
</style>

<div id="light">
    <div class="row">
        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
            <a class="boxclose" id="boxclose" onclick="lightbox_close();"></a>
            <pre id="myCode"></pre>
        </div>
    </div>

    @* <video id="VisaChipCardVideo" width="1000" controls>
    <source src="@Url.Content("~/Video/mov_bbb.mp4")" type="video/mp4">
    <source src="@Url.Content("https://www.w3schools.com/html/mov_bbb.mp4")" type="video/mp4">
    </video> *@
</div>
<div id="fade" onClick="lightbox_close();"></div>
<div class="container" id="partyListSummary">
    <div class="card border-0 shadow rounded-3">
        <div class="card-body">


            <div class="row pt-1">
                <div class="col-xl-3 col-lg-3 col-md-3 col-sm-12">
                    @* <input type="hidden" asp-for="WarehouseID" />*@

                    <label class="col-form-label">
                        Warehouse
                        <a class="bDISU SearchToolTip DUISLIcons" id="btnSearchSAPItemDetailwsss">
                            &nbsp;
                        </a>
                    </label>
                    <select class="form-select" tabindex="1" id="choices-multiple-WareHouse" asp-items="@MarketingExtension.GetAllSAPWareHouseAsync()">
                        <option value="" selected>Select Warehouse Here...</option>
                    </select>
                </div>
                <div class="col-xl-3 col-lg-3 col-md-3 col-sm-12">
                    @*<input type="hidden" asp-for="ItemGroupNameID" />*@
                    <label class="col-form-label">
                        Item Group
                        <a id="btnSAPItemgroup"
                           onclick="fnItemDocumentList()"
                           class="bDISU border DUISLIcons"
                           href="javascript:void(0)"
                           data-id="0"
                           data-bs-toggle="offcanvas"
                           data-bs-target="#canvasItemDocumentList"
                           aria-controls="canvasItemDocumentList">
                            <iconify-icon icon="prime:link" width="17" height="11"></iconify-icon>
                        </a>
                    </label>
                    <select class="form-select" tabindex="2" id="choices-multiple-ItemGroup" asp-items="@MarketingExtension.GetAllSAPItemGroupAsync()">
                        <option value="" selected>Select Item Group Here...</option>
                    </select>
                </div>

                <div class="col-xl-3 col-lg-3 col-md-3 col-sm-12">
                    <label class="col-form-label">Search In Item Desc.</label>
                    <div class="input-group">
                        <input type="text" class="form-control" tabindex="3" id="SearchString" placeholder="Search by string." value="@ViewBag.SearchString" aria-describedby="btnSearchSAPItemDetail">
                        @* bDISU = btnDailyItemStockUpdate *@
                        <a class="bDISU SearchToolTip border DUISLIcons" id="btnSearchSAPItemDetail" onclick="fnSearchSAPItem(true)">
                            <iconify-icon icon="fluent:box-search-20-regular" tabindex="4" width="25" height="22"></iconify-icon>
                            <span class="SearchToolTipText">Search</span>
                        </a>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-3 col-md-3 col-sm-12">
                    <div class="SAPItemCollectionSreachButton pt-3">

                        <div class="row">
                            @*   <a class="pointer" id="openPdfBtn">
                            PDF
                            </a> *@
                            <div class="col-4 ">
                                <a class="btn ResetToolTip border rounded DUISLIcons" tabindex="5" id="btnResetSAPItemDetail1" onclick="fnResetSAPItem(true)">
                                    <iconify-icon icon="system-uicons:reset-temporary" width="27" height="27"></iconify-icon>
                                    <span class="ResetToolTipText">Reset</span>
                                </a>
                            </div>
                            <div class="col-4 DocumentToolTip">
                                <a class="btn border rounded DUISLIcons" asp-area="Marketing" tabindex="6" asp-controller="SAPItemCollection" asp-action="OpenDocument" asp-route-fileName="ItemSearchEngineForUpdatedStock.pdf" target="_blank">
                                    <iconify-icon icon="streamline:desktop-help" width="27" height="27"></iconify-icon>
                                </a>
                                <span class="DocumentToolTipText">Document</span>
                            </div>
                            <div class="col-4 VideoToolTip d">
                                <a class="btn border rounde DUISLIcons" onclick="lightbox_open();">
                                    <iconify-icon icon="fluent:video-switch-24-regular" width="27" height="27"></iconify-icon>
                                </a>
                                <span class="VideoToolTipText">Video</span>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
            <div class="row">
                <div class="col-xl-9 col-lg-9 col-md-9 col-sm-12">
                    <marquee scrollamount="2" class="text-danger">You can search string comma separated Eg:- " PW,0.5,BK,100 mtr -> 'PW IS 694 / ABC 0.50 BK (16/0.200/2.10+0.10/A7) / 100 MTRS RoHS' "</marquee>
                </div>
            </div>
            <hr>
            <div class="row pt-1">

                <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                    <grid model="@Model" />
                </div>


                <div class="modal fade" id="BuyerListModal" tabindex="-1" aria-labelledby="BuyerModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header" style="background-color: #dee3f9;">
                                <h1 class="modal-title fs-6">
                                    <label>Item Name:</label><br>
                                    <label id="BuyerModalLabel" style="font-style:"></label>
                                </h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="itemModalBody">

                                <div id="CustomerListTable">
                                    <div class="row" style="overflow:auto;padding:0px 25px 0px 25px;">
                                        <table class="table border border-dark text-center" style="white-space: nowrap; font-size:inherit !important;" id="customerTable">
                                            @* style="display:block; overflow: auto; white-space: nowrap;" *@
                                            <thead style="position: sticky; top: 0; background-color:#e9ecf8; color:black; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                                <tr>
                                                    <th>Customer Name</th>
                                                    <th>Volume</th>
                                                </tr>
                                            </thead>
                                            <tbody class="border border-dark"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>
</div>
<div class="offcanvas offcanvas-end" tabindex="-1" id="canvasItemDocumentList" style="visibility: visible; width : 75% !important">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="canvasHeaderNameDocument"></h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body pt-3 pb-5">
        <div id="dvInfoDocument">
        </div>
    </div>
</div>
@await Html.PartialAsync("_ValidationScriptsPartial")
<script type="text/javascript">
    var urlGetItemDocumentList = '@Url.Action("GetItemDocumentList", "SAPItemCollection")';

    function fnResetSAPItem() {
        let SAPItemUrl = '@Url.Action("Index", "SAPItemCollection")';
        window.location.href = SAPItemUrl;

    };

    document.getElementById('SearchString').onkeydown = function (event) {
        var e = event || window.event;
        if (e.keyCode == 13) {
            fnSearchSAPItem();
        }
    }
    document.getElementById('btnSearchSAPItemDetail').onkeydown = function (event) {
        var e = event || window.event;
        if (e.keyCode == 13) {
            fnSearchSAPItem();
        }
    }
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl)
    })


    function fnSearchSAPItem() {
        var searchString = $('#SearchString').val();
        let SAPItemUrl = '@Url.Action("Index", "SAPItemCollection")';
        let itemgroup = document.getElementById("choices-multiple-ItemGroup");
        let itemgroupIndex = itemgroup.options[itemgroup.selectedIndex];
        let itemgroupValue = itemgroupIndex.value;

        let wareHouse = document.getElementById("choices-multiple-WareHouse");
        let whIndex = wareHouse.options[wareHouse.selectedIndex];
        let whValue = whIndex.value;


        let viewAllSAPItemList = SAPItemUrl + '?search=' + searchString + '&itemGroup=' + itemgroupValue + '&wareHouse=' + whValue;
        window.location.href = viewAllSAPItemList;
    };


    $(document).ready(function () {

        $("#choices-multiple-ItemGroup option[value='" + '@Html.Raw(itemGroup)' + "']").prop("selected", true);

        var multipleCancelButtonItemGroup = new Choices('#choices-multiple-ItemGroup', {
            removeItemButton: false,
            maxItemCount: 10,
            searchResultLimit: 10,
            renderChoiceLimit: 10
        });


        $("#choices-multiple-WareHouse option[value='" + '@Html.Raw(wareHouse)' + "']").prop("selected", true);

        var multipleCancelButtonWareHouse = new Choices('#choices-multiple-WareHouse', {
            removeItemButton: false,
            maxItemCount: 10,
            searchResultLimit: 10,
            renderChoiceLimit: 10
        });
    });


    function fnOpenBuyerList(obj) {
        let itemCode = obj.dataset.id;
        const headLabel = document.getElementById('BuyerModalLabel');
        headLabel.textContent = obj.dataset.name;

        // $('#BuyerListModal').modal('show');

        let urlOpenBuyerList = '@Url.Action("GetCustomerListByItemCode", "SAPItemCollection")';
        let _parameters = { itemCode: itemCode };
        $.ajax({
            url: urlOpenBuyerList,
            type: "GET",
            data: _parameters,
            dataType: 'json',
            success: function (data) {
                // $("#BuyerListModal").show();//('hide');
                //$('#itemModalBody').html(data);
                if (data != null && data.status) {
                    var table = document.getElementById('customerTable');

                    // Loop through the dataArray and create a row for each item
                    // data.customerListByItemCodes.forEach(function (item) {
                    //     debugger;
                    //     // Create a new table row (tr element)
                    //     var row = table.insertRow();
                    //     // Create cells for "ID," "Name," and "Age"
                    //     var idCell = row.insertCell(0);
                    //     var nameCell = row.insertCell(1);
                    //     // Set the cell values
                    //     idCell.innerHTML = item.customerName;
                    //     nameCell.innerHTML = item.volume;

                    $('#customerTable tbody').empty();
                    var listData = data.customerListByItemCodes;
                    if (listData.length > 0) {
                        $.each(listData, function (i, item) {
                            let custName = item.customerName.replace(/ /g, "+");
                            const rows = '<tr><td><a onclick="fnShowSummury(this)" data-custName=' + custName + ' data-indexNo=' + i + ' data-itemCode=' + itemCode + ' data-bs-toggle="collapse" href="#collapseExample' + i + '" role="button" aria-expanded="false" aria-controls="collapseExample' + i + '">' + item.customerName + '</a><div class="collapse" id="collapseExample' + i + '"></div></td><td><a>' + item.volume + '</a></td></tr>';

                            // BELOW CODE IS FOr AUTO GENERATE TABLE
                            //<table class="table table-striped border border-dark text-center" style="white-space: nowrap; font-size:inherit !important;" id ="customerTable' + i + '"><thead style="position: sticky; top: 0; background-color:#e9ecf8; color:black; font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;" ><tr><th>Month - Year</th><th>Volume</th></tr></thead><tbody class="border border-dark" id="colapseTableId' + i + '"></tbody></table>
                            //<table class="table table-striped border border-dark text-center" style="white-space: nowrap; font-size:inherit !important;" id ="customerTable'+i+'"><thead style="position: sticky; top: 0; background-color:#e9ecf8; color:black; font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;" ><tr><th>Customer Name </th><th>Volume</th></tr></thead><tbody class="border border-dark" id="colapseTableId'+i+'"><tr><td>Test Success</td><td>Volume List</td></tr></tbody></table>

                            // const rows = '<tr><td><a onclick="fnShoWSummury(this)" data-itemCode=' + itemCode + ' data-customerName=' + item.customerName + ' data-bs-toggle="collapse" href="#collapseExample' + i + '" role="button" aria-expanded="false" aria-controls="collapseExample' + i + '">' + item.customerName + '</a><div class="collapse" id="collapseExample' + i + '"></div></td><td><a>' + item.volume + '</a></td></tr>';

                            $('#customerTable tbody').append(rows);
                            // $('tbody').append(rows);

                        });
                    }
                    else {
                        $('tbody').append('<tr><h1><iconify-icon icon="mdi:text-box-remove-outline" style="color: #37569d;" width="100"></iconify-icon></h1><h3 style="color: red;">No customer found.</h3></tr>');
                    }
                    $('#BuyerListModal').modal('show');
                    // $('#itemModalBody').html(data);
                }
            }
        });
    }

    function fnShowSummury(obj) {

        let customerName = obj.dataset.custname.replace(/\+/g, ' ');
        let indexNo = obj.dataset.indexno;
        let itemCode = obj.dataset.itemcode;
        const tableDiv = document.getElementById('collapseExample' + indexNo);
        let urlOpenBuyerList = '@Url.Action("GetClientSalesSummary", "SAPItemCollection")';
        let _parameters = { itemCode: itemCode, customerName: customerName };
        $.ajax({
            url: urlOpenBuyerList,
            type: "GET",
            data: _parameters,
            dataType: 'json',
            success: function (data) {
                // $("#BuyerListModal").show();//('hide');
                //$('#itemModalBody').html(data);
                if (data != null && data.status) {
                    let tempTable = '<table class="table table-striped border border-dark text-center" style="white-space: nowrap; font-size:inherit !important;" id ="customerTable' + indexNo + '"><thead style="position: sticky; top: 0; background-color:#e9ecf8; color:black; font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;" ><tr><th>Month - Year</th><th>Volume</th></tr></thead><tbody class="border border-dark" id="colapseTableId' + indexNo + '"></tbody></table>';
                    tableDiv.innerHTML = tempTable;

                    var listData = data.listClientSalesSummaryModel;

                    if (listData.length > 0) {
                        $.each(listData, function (j, item) {

                            const newTablerows = '<tr><td>' + item.monthYear + '</td><td>' + item.volume + '</td></tr>';

                            $('#colapseTableId' + indexNo).append(newTablerows);

                        });
                    }
                    else {
                        $('tbody').append('<tr><h1><iconify-icon icon="mdi:text-box-remove-outline" style="color: #37569d;" width="100"></iconify-icon></h1><h3 style="color: red;">No customer found.</h3></tr>');
                    }
                }
            }
        });
    }

    window.document.onkeydown = function (e) {
        if (!e) {
            e = event;
        }
        if (e.keyCode == 27) {
            lightbox_close();
        }
    }

    function lightbox_open() {
        var lightBoxVideo = document.getElementById("VisaChipCardVideo");
        window.scrollTo(0, 0);
        document.getElementById('light').style.display = 'block';
        document.getElementById('fade').style.display = 'block';
        //lightBoxVideo.play();
        //alert('play video');
    }

    function lightbox_close() {
        var lightBoxVideo = document.getElementById("VisaChipCardVideo");
        document.getElementById('light').style.display = 'none';
        document.getElementById('fade').style.display = 'none';
        //lightBoxVideo.pause();
        $('iframe').attr('src', $('iframe').attr('src'));
        //alert('pause video');
    }

    //Below code use for open pdf in popup. Dravesh working on it.
    // // document.getElementById("openPdfBtn").addEventListener("click", function () {
    // //     openPdfInPopup("https://sun260880-001-site1.ctempurl.com/sapitemcollectiondocumentation/ItemSearchEngineForUpdatedStock.pdf");
    // // });

    // function openPdfInPopup(pdfUrl) {
    //     // Set width and height of the popup window
    //     var width = 750;
    //     var height = 650;
    //     alert('pdfUrl--' + pdfUrl);
    //     // Calculate the position of the popup window to center it on the screen
    //     var left = (screen.width - width) / 2;
    //     var top = (screen.height - height) / 2;

    //     // Open the PDF file in a new window
    //     var pdfWindow = window.open(pdfUrl, "_blank", "width=" + width + ",height=" + height + ",left=" + left + ",top=" + top);

    //     // Focus the new window
    //     if (pdfWindow) {
    //         pdfWindow.focus();
    //     } else {
    //         alert("Popup blocked! Please allow popups for this site.");
    //     }
    // }
    //Above code use for open pdf in popup. Dravesh working on it.

    function fnItemDocumentList() {
        //alert('fnItemDocumentList invoked urlGetItemDocumentList-- ' + urlGetItemDocumentList);
        document.getElementById("canvasHeaderNameDocument").innerHTML = "Item Document List";
        $.ajax({
            url: urlGetItemDocumentList,
            type: "GET",
            success: function (data, textStatus, jqXHR) {
                //alert('Success invoked');
                $("#canvasItemDocumentList").show();//('hide');
                $('#dvInfoDocument').html(data);
            }
        });
    }



    var myId = getId('https://www.youtube.com/watch?v=YbJdICUVepE');

    function getId(url) {
        var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        var match = url.match(regExp);

        if (match && match[2].length == 11) {
            return match[2];
        } else {
            return 'error';
        }
    }

    $('#myCode').html('<iframe id="VisaChipCardVideo" src="//www.youtube.com/embed/' + myId + '" width = "1000" height="500" frameborder="0" allow = "accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"allowfullscreen></iframe>');

</script>
